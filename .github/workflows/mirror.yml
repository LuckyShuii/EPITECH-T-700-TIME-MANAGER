name: üîÅ Mirror Repository

on:
  push:
    branches:
      - main
      - staging

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate token access
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_TOKEN }}
        run: |
          echo "üîç Checking repository access..."
          if git ls-remote https://x-access-token:${MIRROR_TOKEN}@github.com/EpitechMscProPromo2027/T-DEV-700-project-PAR_19.git > /dev/null 2>&1; then
            echo "‚úÖ Token has access to the target repository."
          else
            echo "‚ùå ERROR: The token does not have access to 'EpitechMscProPromo2027/T-DEV-700-project-PAR_19'."
            echo "üëâ Make sure you authorized SSO for this organization:"
            echo "   https://github.com/settings/tokens"
            exit 1
          fi

      - name: Push to mirror repo (HTTPS + Token)
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_TOKEN }}
        run: |
          git remote add mirror https://x-access-token:${MIRROR_TOKEN}@github.com/EpitechMscProPromo2027/T-DEV-700-project-PAR_19.git
          git push --mirror mirror
