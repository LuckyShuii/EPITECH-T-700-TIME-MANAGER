name: SonarCloud Analysis

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest

    env:
      TESTCONTAINERS_RYUK_DISABLED: true
      TESTCONTAINERS_CHECKS_DISABLE: true
      DOCKER_HOST: unix:///var/run/docker.sock
      SONAR_HOST_URL: https://sonarcloud.io
      SONAR_TOKEN: ${{ secrets.SONARQUBE_TOKEN }}

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ğŸ¹ GO BACKEND
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§° Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: ğŸ“¦ Install Go dependencies
        working-directory: ./backend
        run: go mod tidy

      - name: ğŸ§ª Run Go tests with coverage
        working-directory: ./backend
        run: |
          echo "Running Go tests..."
          go test ./... -v -coverprofile=coverage.out -covermode=atomic

          # VÃ©rifier que le fichier existe
          if [ -f coverage.out ]; then
            echo "âœ… Coverage file generated"
            
            # IMPORTANT: Corriger les chemins dans coverage.out
            # Remplacer les chemins relatifs par des chemins depuis la racine du projet
            sed -i 's|^app/|backend/|g' coverage.out
            
            # Afficher un Ã©chantillon pour debug
            echo "ğŸ“Š Sample of coverage.out:"
            head -n 5 coverage.out
            
            ls -lh coverage.out
          else
            echo "âŒ coverage.out not generated"
            exit 1
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ğŸ¨ FRONTEND (Vue.js)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # - name: ğŸ§° Setup Node.js
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: "20"

      # - name: ğŸ“¦ Install frontend dependencies
      #   working-directory: ./frontend
      #   run: npm install

      # - name: ğŸ§ª Run frontend tests with coverage
      #   working-directory: ./frontend
      #   run: |
      #     npm run test:unit -- --coverage --coverage-reporter=lcov || echo "âš ï¸ No frontend tests found"

      #     # VÃ©rifier si le fichier de couverture existe
      #     if [ -f coverage/lcov.info ]; then
      #       echo "âœ… Frontend coverage generated"
      #       ls -lh coverage/lcov.info
      #     fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ğŸ” SONARCLOUD SCAN
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Run SonarCloud Scan
        uses: sonarsource/sonarqube-scan-action@v6
