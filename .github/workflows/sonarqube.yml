name: SonarCloud Analysis

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest

    # Add Docker service for testcontainers
    services:
      docker:
        image: docker:dind
        options: --privileged

    env:
      TESTCONTAINERS_RYUK_DISABLED: false
      TESTCONTAINERS_CHECKS_DISABLE: false
      DOCKER_HOST: unix:///var/run/docker.sock
      SONAR_HOST_URL: https://sonarcloud.io
      SONAR_TOKEN: ${{ secrets.SONARQUBE_TOKEN }}
      TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE: /var/run/docker.sock
      TESTCONTAINERS_HOST_OVERRIDE: localhost

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ğŸ¹ GO BACKEND
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§° Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22" # Fixed version number

      - name: ğŸ“¦ Install Go dependencies
        working-directory: ./backend
        run: go mod tidy

      - name: ğŸ³ Pull PostgreSQL image (pre-cache)
        run: docker pull postgres:16

      - name: ğŸ§ª Run Go tests with coverage
        working-directory: ./backend
        run: |
          echo "Running Go tests..."
          # Run tests with timeout and parallelism control
          go test ./... -v -timeout 10m -p 1 -coverprofile=coverage.out -covermode=atomic

          # Verify coverage file exists
          if [ -f coverage.out ]; then
            echo "âœ… Coverage file generated"
            
            # Fix paths in coverage.out
            sed -i 's|^app/|backend/|g' coverage.out
            
            # Display sample for debugging
            echo "ğŸ“Š Sample of coverage.out:"
            head -n 5 coverage.out
            
            ls -lh coverage.out
          else
            echo "âŒ coverage.out not generated"
            exit 1
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ğŸ¨ FRONTEND (Vue.js)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # - name: ğŸ§° Setup Node.js
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: "20"

      # - name: ğŸ“¦ Install frontend dependencies
      #   working-directory: ./frontend
      #   run: npm install

      # - name: ğŸ§ª Run frontend tests with coverage
      #   working-directory: ./frontend
      #   run: |
      #     npm run test:unit -- --coverage --coverage-reporter=lcov || echo "âš ï¸ No frontend tests found"

      #     # Check if coverage file exists
      #     if [ -f coverage/lcov.info ]; then
      #       echo "âœ… Frontend coverage generated"
      #       ls -lh coverage/lcov.info
      #     fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ğŸ” SONARCLOUD SCAN
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Run SonarCloud Scan
        uses: sonarsource/sonarqube-scan-action@v6

      # Cleanup step
      - name: ğŸ§¹ Cleanup Docker containers
        if: always()
        run: |
          docker ps -aq | xargs -r docker rm -f || true
